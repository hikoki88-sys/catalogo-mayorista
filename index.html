<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generador de Cat√°logo Mayorista</title>

<style>
body{font-family:Arial, sans-serif;background:#f5f5f5;padding:20px}
h1{text-align:center}
.card{background:#fff;padding:15px;border-radius:8px;max-width:540px;margin:0 auto}
label{display:block;margin-top:10px;font-weight:bold}
input{width:100%;padding:8px;margin-top:5px}
button{margin-top:12px;width:100%;padding:12px;font-size:15px;border-radius:6px;border:none;cursor:pointer}
.producto{border:1px solid #ddd;padding:10px;border-radius:6px;margin-top:15px}
.btn-pdf{background:#111;color:#fff}
.btn-wsp{background:#25D366;color:#fff}
.small{font-size:12px;color:#666;margin-top:8px}
</style>
</head>

<body>

<h1>Cat√°logo Mayorista</h1>

<div class="card">

  <label>üì∑ Logo del negocio (opcional)</label>
  <input type="file" id="logoInput" accept="image/*">

  <label>üì± N√∫mero WhatsApp (+51...)</label>
  <input type="text" id="wspNumero" placeholder="Ej: 51987654321">

  <label>üí¨ Mensaje de WhatsApp</label>
  <input type="text" id="wspMensaje" value="Hola, te env√≠o mi cat√°logo mayorista. Av√≠same cualquier consulta.">

  <div id="productos"></div>

  <button onclick="agregarProducto()">‚ûï Agregar Zapatilla</button>
  <button class="btn-pdf" onclick="generarPDF()">üìÑ Generar PDF</button>
  <button class="btn-wsp" onclick="enviarWhatsApp()">üü¢ Enviar por WhatsApp</button>

  <div class="small">* Funciona offline y online (GitHub Pages)</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// =======================
// ESTADO GLOBAL
// =======================
let productos = [];
let logoData = null;

// =======================
// LOGO
// =======================
document.getElementById("logoInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = () => logoData = r.result;
  r.readAsDataURL(file);
});

// =======================
// AGREGAR PRODUCTO
// =======================
function agregarProducto(){
  const i = productos.length;
  productos.push({});

  const d = document.createElement("div");
  d.className = "producto";
  d.innerHTML = `
    <label>Foto</label>
    <input type="file" accept="image/*" onchange="productos[${i}].foto=this.files[0]">

    <label>Precio</label>
    <input onchange="productos[${i}].precio=this.value">

    <label>Calidad</label>
    <input onchange="productos[${i}].calidad=this.value">

    <label>Tallas</label>
    <input onchange="productos[${i}].tallas=this.value">
  `;

  document.getElementById("productos").appendChild(d);
}

// =======================
// LEER IMAGEN (ALTA CALIDAD)
// =======================
function leerImagen(file){
  return new Promise(resolve => {
    const img = new Image();
    const r = new FileReader();

    r.onload = e => {
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const maxW = 1800;
        const scale = Math.min(1, maxW / img.width);

        canvas.width = img.width * scale;
        canvas.height = img.height * scale;

        const ctx = canvas.getContext("2d");
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        resolve(canvas.toDataURL("image/jpeg", 0.9));
      };
      img.src = e.target.result;
    };

    r.readAsDataURL(file);
  });
}

// =======================
// GENERAR PDF (1 PAR POR P√ÅGINA)
// =======================
async function generarPDF(){
  if(productos.length === 0){
    alert("Agrega al menos un producto");
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  for(let i = 0; i < productos.length; i++){
    const p = productos[i];
    if(!p.foto) continue;

    if(i > 0) pdf.addPage();

    const imgData = await leerImagen(p.foto);
    const imgProps = pdf.getImageProperties(imgData);

    const maxWidth = 170;
    const ratio = imgProps.width / imgProps.height;
    const imgHeight = maxWidth / ratio;

    const startY = 25;

    pdf.addImage(imgData, "JPEG", 20, startY, maxWidth, imgHeight);

    pdf.setFontSize(14);
    pdf.text(`Precio: ${p.precio || ""}`, 25, startY + imgHeight + 15);
    pdf.text(`Calidad: ${p.calidad || ""}`, 25, startY + imgHeight + 30);
    pdf.text(`Tallas: ${p.tallas || ""}`, 25, startY + imgHeight + 45);

    if(logoData){
      pdf.addImage(logoData, "JPEG", 145, startY + imgHeight + 10, 40, 18);
    }
  }

  pdf.save("catalogo_mayorista.pdf");
}

// =======================
// WHATSAPP
// =======================
function enviarWhatsApp(){
  const num = document.getElementById("wspNumero").value.trim();
  if(!num){ alert("Ingresa un n√∫mero de WhatsApp"); return; }

  const msg = document.getElementById("wspMensaje").value;
  window.open(`https://wa.me/${num}?text=${encodeURIComponent(msg)}`, "_blank");
}

// Inicial
agregarProducto();
</script>

</body>
</html>
